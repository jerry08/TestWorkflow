name: discord message

on:
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: false
      NUGET_TOKEN:
        required: true
      DISCORD_WEBHOOK:
        required: false
      # Reusable workflows don't propagate parent's execution context,
      # so we need this hack to pass additional environment variables from the caller.
      DYNAMIC:
        required: false

jobs:

  notify:
    name: testing
    runs-on: ubuntu-latest

    env:
      # Secrets can't be referenced in conditionals, but environment variables can.
      # https://github.com/github/docs/issues/6861#issuecomment-870757186
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Initialize environment
        run: echo "${{ secrets.DYNAMIC }}" >> $GITHUB_ENV

      - name: Get release version
        id: get-version
        uses: dawidd6/action-get-tag@v1

      - name: Notify Discord
        if: ${{ env.DISCORD_WEBHOOK }}
        uses: satak/webrequest-action@v1.2.4
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          headers: |
            {
              "Content-Type": "application/json; charset=UTF-8"
            }
          payload: |
            {
              "content": "**${{ github.event.repository.name }}** new version released!\nVersion: `${{ steps.get-version.outputs.tag }}`\nChangelog: <https://github.com/${{ github.event.repository.full_name }}/blob/${{ steps.get-version.outputs.tag }}/Changelog.md>"
            }
